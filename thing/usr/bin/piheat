#!/usr/bin/env python

## @file piheat.py
#  Main executable for the Pi Heat daemon.
#
#  Prepares working directories and the environment, then invokes methods from the PiHeat class.
#  This script can be used in a way that resembles the `/etc/init.d` scripts.

import sys, os.path
from piheat import PiHeat

pidfile = os.path.expanduser('~/.piheat/piheat.pid')
if pidfile.startswith('/var/lib/piheat'):
  pidfile = '/var/lib/piheat/piheat.pid'

dir_pidfile = os.path.dirname(pidfile)
if os.path.isdir(dir_pidfile):
  try:
    os.chmod(dir_pidfile, 0700)
  except OSError:
    pass
else:
  os.mkdir(dir_pidfile, 0700)

with open(pidfile, 'a') as f:
  pass
os.chmod(pidfile, 0600)

try:
  cmd = sys.argv[1].lower()
except IndexError:
  cmd = None

pih = PiHeat(pidfile)
if cmd == 'start':
  sys.stderr.write('Starting PiHeat...\n')
  pih.start()
elif cmd == 'stop':
  sys.stderr.write('Stopping PiHeat...\n')
  pih.stop()
elif cmd == 'status':
  pih.status()
elif cmd == 'nodaemon':
  pih.run()
else:
  sys.stderr.write( 'Usage: %s [start|stop|nodaemon]\n' % os.path.basename(sys.argv[0]) )
